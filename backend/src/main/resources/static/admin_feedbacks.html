<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin - Feedback</title>
    <link rel="stylesheet" href="style.css">
</head>

<body class="dashboard-body">
    <div class="dashboard-container">
        <div style="margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center;">
            <h2 class="section-title">Gelen GÃ¶rÃ¼ÅŸler</h2>
            <a href="admin_dashboard.html" class="btn-cancel" style="padding:10px 20px; text-decoration:none;">Panele
                DÃ¶n</a>
        </div>

        <div style="display:grid; grid-template-columns: 1fr; gap:30px;">
            <!-- Pending Feedbacks -->
            <div>
                <h3
                    style="color:#d97706; margin-bottom:15px; font-size:18px; border-bottom:2px solid #d97706; padding-bottom:5px; display:inline-block;">
                    Bekleyen GÃ¶rÃ¼ÅŸler</h3>
                <div id="pending-list" style="display:flex; flex-direction:column; gap:20px;">
                    <p>YÃ¼kleniyor...</p>
                </div>
            </div>

            <!-- Replied Feedbacks -->
            <div>
                <h3
                    style="color:#16a34a; margin-bottom:15px; font-size:18px; border-bottom:2px solid #16a34a; padding-bottom:5px; display:inline-block;">
                    YanÄ±tlanan GÃ¶rÃ¼ÅŸler</h3>
                <div id="replied-list" style="display:flex; flex-direction:column; gap:20px; opacity: 0.8;">
                    <p>YÃ¼kleniyor...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="ui.js"></script>
    <!-- Reply Modal -->
    <div id="replyModal" class="modal-overlay" style="display:none;">
        <div class="modal-box" style="max-width: 700px; width: 90%;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 class="modal-title">YanÄ±t OluÅŸtur</h3>
                <span style="cursor:pointer; font-size:20px;" onclick="closeReplyModal()">&times;</span>
            </div>

            <!-- Original Message Context -->
            <div
                style="background:#f8fafc; padding:10px; border-radius:6px; margin-bottom:15px; border:1px solid #e2e8f0;">
                <label style="font-size:12px; color:#64748b; font-weight:bold;">KULLANICI MESAJI</label>
                <p id="modalUserMessage" style="font-style:italic; color:#334155; margin:5px 0; font-size:14px;">...</p>
            </div>

            <!-- Admin Notes -->
            <div style="margin-bottom:15px;">
                <label style="font-weight:bold; font-size:14px;">Sizin NotlarÄ±nÄ±z / TalimatlarÄ±nÄ±z</label>
                <textarea id="adminNotes" class="modal-input" rows="3"
                    placeholder="Ã–rn: TeÅŸekkÃ¼r et, sorunun haftaya Ã§Ã¶zÃ¼leceÄŸini sÃ¶yle."
                    style="margin-top:5px; font-family:inherit; width: 100%;"></textarea>
                <div style="text-align: right; margin-top: 8px;">
                    <button class="btn-action"
                        style="background:#8b5cf6; width:auto; padding: 8px 16px; display: inline-block;"
                        onclick="generateSmartReply()">âœ¨ AI ile Yaz</button>
                </div>
            </div>

            <!-- Final Draft -->
            <div style="margin-bottom:20px;">
                <label style="font-weight:bold; font-size:14px;">Taslak YanÄ±t (DÃ¼zenlenebilir)</label>
                <textarea id="finalReply" rows="6" class="modal-input"
                    style="margin-top:5px; font-family:inherit;"></textarea>
            </div>

            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeReplyModal()">VazgeÃ§</button>
                <button class="modal-btn btn-confirm" onclick="sendReply()">GÃ¶nder ğŸš€</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';

        let currentFeedbackMessage = "";
        let currentFeedbackId = null;

        async function loadFeedbacks() {
            try {
                const response = await fetch(`${API_URL}/feedbacks`);
                const feedbacks = await response.json();

                const pendingContainer = document.getElementById('pending-list');
                const repliedContainer = document.getElementById('replied-list');

                pendingContainer.innerHTML = '';
                repliedContainer.innerHTML = '';

                if (feedbacks.length === 0) {
                    pendingContainer.innerHTML = '<p>HenÃ¼z bir gÃ¶rÃ¼ÅŸ yok.</p>';
                    return;
                }

                // Sort: Newest First
                feedbacks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                feedbacks.forEach(fb => {
                    const card = document.createElement('div');
                    card.style.background = 'white';
                    card.style.padding = '20px';
                    card.style.borderRadius = '12px';
                    card.style.boxShadow = '0 2px 8px rgba(0,0,0,0.05)';

                    const date = new Date(fb.createdAt).toLocaleString('tr-TR');
                    // Escape quotes for onclick
                    const safeMessage = (fb.message || "").replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const isReplied = fb.replied === true;

                    // Header Color
                    const headerColor = isReplied ? '#16a34a' : '#d97706';
                    const icon = isReplied ? '<i class="fa-solid fa-check-circle"></i>' : '<i class="fa-regular fa-clock"></i>';

                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px solid #f1f5f9; padding-bottom:10px;">
                            <span style="font-weight:bold; color:${headerColor}; display:flex; align-items:center; gap:5px;">
                                ${icon} User: ${fb.user?.username || 'Misafir'}
                            </span>
                            <span style="color:#94a3b8; font-size:13px;">${date}</span>
                        </div>
                        <p style="color:#334155; line-height:1.6; margin-bottom:15px; font-size:15px;">${fb.message}</p>
                        ${isReplied && fb.reply ?
                            `<div style="background:#f0fdf4; border-left:4px solid #16a34a; padding:10px; margin-bottom:15px; border-radius:4px;">
                                <small style="display:block; font-weight:bold; color:#166534; margin-bottom:5px;">YÃ¶netici YanÄ±tÄ±:</small>
                                <p style="margin:0; color:#15803d; font-size:14px;">${fb.reply}</p>
                             </div>`
                            : ''}
                        ${!isReplied ?
                            `<button class="btn-action" style="width:auto; padding:8px 16px; font-size:13px;" onclick="openReplyModal('${safeMessage}', ${fb.id})">â†©ï¸ YanÄ±tla</button>`
                            : `<span style="font-size:12px; color:#16a34a; font-weight:bold; background:#dcfce7; padding:4px 10px; border-radius:20px;">YanÄ±tlandÄ±</span>`}
                    `;

                    if (isReplied) {
                        repliedContainer.appendChild(card);
                    } else {
                        pendingContainer.appendChild(card);
                    }
                });

                if (pendingContainer.children.length === 0) pendingContainer.innerHTML = '<p style="color:#94a3b8; font-style:italic;">Bekleyen gÃ¶rÃ¼ÅŸ yok.</p>';
                if (repliedContainer.children.length === 0) repliedContainer.innerHTML = '<p style="color:#94a3b8; font-style:italic;">HenÃ¼z yanÄ±tlanan gÃ¶rÃ¼ÅŸ yok.</p>';

            } catch (e) {
                console.error(e);
                document.getElementById('pending-list').innerHTML = '<p style="color:red;">Hata oluÅŸtu.</p>';
            }
        }

        function openReplyModal(message, feedbackId) {
            currentFeedbackMessage = message;
            currentFeedbackId = feedbackId;
            document.getElementById('modalUserMessage').innerText = message;
            document.getElementById('adminNotes').value = '';
            document.getElementById('finalReply').value = '';
            document.getElementById('replyModal').style.display = 'flex';
        }

        function closeReplyModal() {
            document.getElementById('replyModal').style.display = 'none';
        }

        async function generateSmartReply() {
            const notes = document.getElementById('adminNotes').value;
            if (!notes) {
                showToast("LÃ¼tfen Ã¶nce kÄ±sa bir not veya talimat yazÄ±n.");
                return;
            }

            showToast("AI yanÄ±tÄ± hazÄ±rlÄ±yor... â³", "info");

            const prompt = `AÅŸaÄŸÄ±daki kullanÄ±cÄ± mesajÄ±na, yÃ¶netici notlarÄ±na dayanarak RESMÄ°, NAZÄ°K ve PROFESYONEL bir e-posta/mesaj cevabÄ± yaz.
            
            KullanÄ±cÄ± MesajÄ±: "${currentFeedbackMessage}"
            YÃ¶netici NotlarÄ±/TalimatÄ±: "${notes}"
            
            Kurallar:
            1. Sadece cevap metnini yaz (GiriÅŸ ve bitiÅŸ dahil).
            2. Markdown kullanma (YÄ±ldÄ±z *, kare # vs. kullanma). DÃ¼z metin olsun.
            3. TÃ¼rkÃ§e yaz.`;

            try {
                const response = await fetch('/api/ai/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: prompt })
                });

                if (response.ok) {
                    const data = await response.json();
                    let aiText = data.response;
                    aiText = aiText.replace(/\*\*/g, '').replace(/\*/g, '-').replace(/#/g, '');
                    document.getElementById('finalReply').value = aiText.trim();
                } else {
                    showToast("AI servisine ulaÅŸÄ±lamadÄ±.");
                }
            } catch (error) {
                console.error(error);
                showToast("Hata oluÅŸtu.");
            }
        }

        async function sendReply() {
            const final = document.getElementById('finalReply').value;
            if (!final) {
                showToast("BoÅŸ yanÄ±t gÃ¶nderilemez.");
                return;
            }

            if (!currentFeedbackId) {
                showToast("Hata: Feedback ID kayÄ±p.");
                return;
            }

            try {
                showToast("YanÄ±t gÃ¶nderiliyor...", "info");
                const response = await fetch('/api/admin/feedback/reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        feedbackId: currentFeedbackId,
                        reply: final
                    })
                });

                if (response.ok) {
                    showToast("YanÄ±t baÅŸarÄ±yla gÃ¶nderildi! âœ…", "success");
                    closeReplyModal();
                    loadFeedbacks(); // Refresh list to move item to replied section
                } else {
                    const txt = await response.text();
                    showToast("Hata: " + txt);
                }
            } catch (e) {
                console.error(e);
                showToast("Sunucu hatasÄ±.");
            }
        }

        loadFeedbacks();
    </script>
</body>

</html>